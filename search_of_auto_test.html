<!doctype html><html lang="zh-CN" class="night"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=4,user-scalable=0" name="viewport"><title>Edeity&#39;s Blog</title><meta name="description" content="Try to be a qualified programmer"><meta property="og:type" content="website"><meta property="og:description" content="Try to be a qualified programmer"><meta property="og:title" content="Edeity&#39;s Blog"><meta property="og:site_name" content="Edeity&#39;s Blog"><meta property="og:url" content="https://blog.edeity.me"><meta property="og:image" content="https://edeity.oss-cn-shenzhen.aliyuncs.com/public/edeity_o.png"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="mainfest" href="/mainfest.json"><link rel="stylesheet" href="/public/css/common.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_707055_4b9og9sc5lx.css"><script>document.addEventListener("DOMContentLoaded",(function(){let e=-1!==window.location.search.indexOf("theme=night")||"night"===window.localStorage.getItem("edeity-theme_theme"),t=-1!==window.location.search.indexOf("theme=light")||"light"===window.localStorage.getItem("edeity-theme_theme"),o=(new Date).getHours();o=22;var n=document.querySelector("html");(e?n.classList.add("night"):t?n.classList.remove("night"):n.classList.add("night"),null!==document.querySelector("ol.toc"))&&(document.querySelector("#nav-bar").style.cssText="display: block")}))</script><meta name="generator" content="Hexo 5.2.0"></head><body><div class="loading"></div><div id="switch" data-switch="{&#34;toc&#34;:true,&#34;use_pwa&#34;:false}"></div><header class="fullscreen"><div class="toolbar"><i class="iconfont icon-menu"></i></div><h1><a href="/">Edeity&#39;s Blog</a></h1><div class="head-link"><a class="btn waves" href="/"><span><i class="iconfont icon-home">Home </i></span></a><a class="btn waves" href="/about/index.html"><span><i class="iconfont icon-me">About </i></span></a><a class="btn waves" target="_blank" rel="noopener" href="https://github.com/edeity"><span><i class="iconfont icon-github">Github</i></span></a></div></header><div class="some-link"><a class="btn" id="light-or-not"><i class="iconfont icon-light"></i> </a><a style="display:none" class="btn" id="up-to-top"><i class="iconfont icon-up"></i></a></div><div id="nav-bar" style="display:none"><div class="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins"><span class="toc-number">1.</span> <span class="toc-text">Jenkins</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">1.3.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#puppeteer"><span class="toc-number">2.</span> <span class="toc-text">puppeteer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E8%BF%91%E4%B8%80%E6%AD%A5"><span class="toc-number">3.</span> <span class="toc-text">更近一步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96-1"><span class="toc-number">3.1.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div><main id="content-main" class="section"><div class="list-item"><h1 class="post-title"><a id="前端自动化测试探索" class="article-link" href="">前端自动化测试探索</a></h1><div class="post-meta"><time class="meta published">Mar 10, 2020</time></div><div class="article"><div class="post-excerpt markdown-body"><p>众所周知，在迭代过程中会引入各种问题，为了尽可能避免或减少问题，尤其是曾发现的问题，要进行回归测试。</p><p>函数库，因为有严格的输入输出，容易写单元测试；前端业务的问题，因老板关注，投入了大量测试资源，多层次测试；但性能上的问题，则相对晦涩。曾有一个性能问题，在被无意间发现时，已在线上存在N月。因此，一个产品越复杂，迭代越频繁，越有必要提供能面向整个开发流程的自动化测试工具。</p><ul><li>要尽可能操作浏览器，及时获取运行信息</li><li>要提供非代码的操作方式，说白了，就是图形界面</li></ul><p>只有在满足以上两者后，我们才可以逐渐完善诸如冒烟测试的测试用例，也可以约定指标，量化前端特性。</p><p>针对前端业务，经过一定时间的了解，目前有一种不成熟的解题思路：<a target="_blank" rel="noopener" href="https://github.com/puppeteer/puppeteer">puppeteer</a> + <a target="_blank" rel="noopener" href="https://jenkins.io/zh/">jenkins</a> 以供参考。</p><h2 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><blockquote><p>Jenkins是一个<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6/8105369">开源软件</a>项目，是基于<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/Java/85979">Java</a>开发的一种<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/6250744">持续集成</a>工具，用于监控持续重复的工作，旨在提供一个开放易用的软件平台</p></blockquote><p>最常用的功能，根据某种条件（如提交代码、定时、用户点击等），运行各类脚本或软件，记录运行日志，最终要的是提供图形界面的软件。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>以windows为例<small>（公司的电脑只给配了windows）</small>，下载最新版的<code>jenkins.war</code>，安装运行<code>.war</code>所需的JAVA环境</p><ul><li>因为网络不佳，所以推荐用<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/">清华源</a>下载<code>Jenkins</code>以及其插件。</li><li>JAVA下载过慢，也可以到腾讯应用用心搜索<code>JRE</code></li></ul><p>以8080为端口，运行程序：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -jar ./your/path/to/jenkins.war --httpPort=8080</span><br></pre></td></tr></table></figure><p>值得注意，虽然<code>jenkins</code>是通过清华源下载的，但默认的插件安装，仍然以官方地址下载，所以很卡或干脆安装不成功，故同样需要换成清华源。具体做法，运行后，Jenkins会在用户目录（如<code>C:\Users\admin\</code>）创建<code>.jenkins</code>文件夹，里面保存了相关配置，打开<code>hudson.model.UpdateCenter</code>，将其中的</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">url</span>&gt;</span>https://updates.jenkins.io/update-center.json<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br></pre></td></tr></table></figure><p>替换为</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">url</span>&gt;</span>https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br></pre></td></tr></table></figure><p>再次运行<code>jenkins.war</code>，我们会看到在<code>.jenkins/updates/</code>下多了<code>default.json</code>文件。但此时也只是把下载了插件的地址（这些地址还是官方网址），故需要打开此文件，全局替换：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">http:<span class="comment">//www.google.com </span></span><br><span class="line">-&gt; http:<span class="comment">//www.baidu.com</span></span><br><span class="line"></span><br><span class="line">http:<span class="comment">//updates.jenkins-ci.org/download </span></span><br><span class="line">-&gt; https:<span class="comment">//mirrors.tuna.tsinghua.edu.cn/jenkins</span></span><br></pre></td></tr></table></figure><p>再次运行<code>jenkins.war</code>，打开<code>http://localhost:8080</code>，按照里面的提示操作即可顺利安装插件。</p><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul><li>为避免权限不足，可能需要以<code>管理员</code>身份运行shell，进而启动<code>jenkins</code>。（比如无法找到cnpm命令）</li><li>jenkins在window下默认以cmd运行，若要更改成shell（比如：git自带的cygwin），可以到<code>Manage Jenkins</code>-&gt; <code>Config Systems</code> -&gt;<code>Shell</code>中说明本地shell的路径： <code>C:\Program Files\Git\bin\sh.exe</code></li><li>运行控制台输出时，默认的JAVA环境未能识别中文，呈现乱码，这不是jenkins的问题，需要添加JAVA的<code>环境变量</code>。<ul><li><code>JAVA_TOOL_OPTIONS</code>：<code>-Dfile.encoding=UTF-8</code></li></ul></li></ul><h2 id="puppeteer"><a href="#puppeteer" class="headerlink" title="puppeteer"></a>puppeteer</h2><p>Jenkins为非开发者提供了图形界面接口，但测试用例的编写才是根本。如何能尽可能模拟用户的操作？还用问，当然是用浏览器啦。但不是用手，那是测试的事，像我这样风度翩翩的前端er，用<code>puppeteer</code>：<a target="_blank" rel="noopener" href="https://zhaoqize.github.io/puppeteer-api-zh_CN/"><code>puppeteer</code></a>是一组API，封装<a target="_blank" rel="noopener" href="https://chromedevtools.github.io/devtools-protocol"><code>devtools-protocol</code></a>远程调用协议，能够简单粗暴地操作Chromium。</p><p>API设计得非常凝练，短短几句话就能模拟用户操作，参照官网实例:</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">&#x27;puppeteer&#x27;</span>);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 启动Chromium</span></span><br><span class="line">  <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line">  <span class="comment">// 新建一个页面</span></span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">  <span class="comment">// 打开百度</span></span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">&#x27;https://www.baidu.com&#x27;</span>);</span><br><span class="line">  <span class="comment">// 模拟用户输入`Hello World`</span></span><br><span class="line">  <span class="keyword">await</span> page.keyboard.type(<span class="string">&#x27;Hello World&#x27;</span>);</span><br><span class="line">  <span class="comment">// 对当前页面进行截图，并保存为example.png</span></span><br><span class="line">  <span class="keyword">await</span> page.screenshot(&#123;<span class="attr">path</span>: <span class="string">&#x27;example.png&#x27;</span>&#125;);</span><br><span class="line">    <span class="comment">// 关闭浏览器</span></span><br><span class="line">  <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>当然，<code>puppeteer</code>支持以<code>无头</code>（没有界面）的形式运行。这样便可以神不知鬼不觉地在后台跑各种任务了。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;<span class="attr">headless</span>: <span class="literal">false</span>&#125;);</span><br></pre></td></tr></table></figure><h2 id="更近一步"><a href="#更近一步" class="headerlink" title="更近一步"></a>更近一步</h2><p>如何使用puppeteer，可以直接查看官方API：</p><ul><li>模拟用户操作（键盘输入：<code>keyboard.type</code>，鼠标点击：<code>mouse.down</code>）</li><li>在浏览器中运行JS，并获取信息：(<code>page.evalute</code>)</li><li>性能跟踪：<code>tracing.start</code></li><li>….</li></ul><p><del>只有你想不到，没有你做不到。</del>当然，假如目前提供的API，还不够风骚刺激，也可以通过<a target="_blank" rel="noopener" href="https://chromedevtools.github.io/devtools-protocol/">底层协议</a>进行更深入的操作（怀疑博主在ghs），eg：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 勾搭上chromium</span></span><br><span class="line"><span class="keyword">const</span> client = <span class="keyword">await</span> page.target().createCDPSession();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用Animation.enable方法</span></span><br><span class="line"><span class="keyword">await</span> client.send(<span class="string">&#x27;Animation.enable&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行Animation.enable后，监听Animation.animationCreated事件</span></span><br><span class="line">client.on(<span class="string">&#x27;Animation.animationCreated&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Animation created!&#x27;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，要注意一点，别把事件（<code>Events</code>）变操作（<code>Methods</code>），比如：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">client.send(<span class="string">&#x27;Animation.animationCreated&#x27;</span>); <span class="comment">// no such method</span></span><br></pre></td></tr></table></figure><h3 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h3><p>当然，使用<code>puppeteer</code>的同时，也会用到其它的类库，仅列于下供参考：</p><ol><li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/resemblejs">resemblejs</a>：对两张图片进行差异对比。<small>（比如，可以将主干的一系列操作截图视为正确结果，从而对比分支相同操作截图，发现差异）</small><ul><li>screenshot截图时，耗时100ms~1s，所以不适宜截图衡量性能，ms级别的操作，仍旧推荐使用埋点</li></ul></li><li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/nodemail">nodemail</a>： 发邮件</li><li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/axios">axios</a>：请求接口</li><li><code>mochai</code> + <code>chai</code>：写单元测试用例</li><li>….</li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>目前，这个解决方案正由本猿在本小组推行使用，有更多的结论，我还会回来记（zhuang）录（bi）的！</p></div></div></div><div class="more section"><div class="pre"><a class="article-link" href="/detail_of_throttle.html"><i class="iconfont icon-right"></i> <span>throttle细节小记</span></a></div><div class="next"><a class="article-link" href="/bey_2019_and_hi_2020.html">2019年终将过去 <i class="iconfont icon-right"></i></a></div></div></main></body><footer class="section fullscreen"><div class="footer-desc">Edeity © 2015-2019 · powered by hexo</div></footer><script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script><script src="/public/js/init.js"></script></html>