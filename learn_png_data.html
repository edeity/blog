<!doctype html><html lang="zh-CN" class="night"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=4,user-scalable=0" name="viewport"><title>Edeity&#39;s Blog</title><meta name="description" content="Try to be a qualified programmer"><meta property="og:type" content="website"><meta property="og:description" content="Try to be a qualified programmer"><meta property="og:title" content="Edeity&#39;s Blog"><meta property="og:site_name" content="Edeity&#39;s Blog"><meta property="og:url" content="https://blog.edeity.me"><meta property="og:image" content="https://edeity.oss-cn-shenzhen.aliyuncs.com/public/edeity_o.png"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="mainfest" href="/mainfest.json"><link rel="stylesheet" href="/public/css/common.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_707055_4b9og9sc5lx.css"><script>// 切换暗夜模式，需要在CSS渲染前调整，否则重绘时会闪烁
        document.addEventListener('DOMContentLoaded', function () {
            // 是否需要切换黑夜模式
            let isForceNightTheme = window.location.search.indexOf('theme=night') !== -1
                || window.localStorage.getItem('edeity-theme_theme') === 'night';
            let isForceLightTheme = window.location.search.indexOf('theme=light') !== -1
                || window.localStorage.getItem('edeity-theme_theme') === 'light';
            let hours = new Date().getHours();
            hours = 22;
            var html = document.querySelector('html')
            if (isForceNightTheme) {
                html.classList.add('night');
            } else if (isForceLightTheme) {
                html.classList.remove('night');
            } else {
                // 没有强制开关，用时间计算
                if (hours < 8 || hours >= 20) {
                    html.classList.add('night');
                } else {
                    html.classList.remove('night');
                }
            }
            // 是否需要隐藏左侧导航栏
            if (document.querySelector('ol.toc') !== null) {
                var bar = document.querySelector('#nav-bar')
                bar.style.cssText = 'display: block'
            }
        });</script><meta name="generator" content="Hexo 5.0.0"></head><body><div class="loading"></div><div id="switch" data-switch="{&#34;toc&#34;:true,&#34;use_pwa&#34;:false}"></div><header class="fullscreen"><div class="toolbar"><i class="iconfont icon-menu"></i></div><h1><a href="/">Edeity&#39;s Blog</a></h1><div class="head-link"><a class="btn waves" href="/"><span><i class="iconfont icon-home">Home </i></span></a><a class="btn waves" href="/about/index.html"><span><i class="iconfont icon-me">About </i></span></a><a class="btn waves" target="_blank" rel="noopener" href="https://github.com/edeity"><span><i class="iconfont icon-github">Github</i></span></a></div></header><div class="some-link"><a class="btn" id="light-or-not"><i class="iconfont icon-light"></i> </a><a style="display:none" class="btn" id="up-to-top"><i class="iconfont icon-up"></i></a></div><div id="nav-bar" style="display:none"><div class="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96pHYs"><span class="toc-number">2.</span> <span class="toc-text">获取pHYs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">3.</span> <span class="toc-text">其他</span></a></li></ol></div></div><main id="content-main" class="section"><div class="list-item"><h1 class="post-title"><a id="获取PNG中的“分辨率”" class="article-link" href="">获取PNG中的“分辨率”</a></h1><div class="post-meta"><time class="meta published">Dec 15, 2018</time></div><div class="article"><div class="post-excerpt markdown-body"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>换了公司，做的第一个需求：水印预览。</p><p>完成功能后，发现有的图片和C艹内核渲染<strong>尺寸不一致</strong>。分析后发现，C++处理PNG图片时，除了考虑基本像素外，还会按照PNG的分辨率加以缩放。（eg：win下课通过查看图片，<code>水平（或垂直）分辨率：xxx dpi</code>得到值）</p><p>dpi、ppi或px等的关系，详见<a target="_blank" rel="noopener" href="https://github.com/jawil/blog/issues/21">CSS像素、物理像素、逻辑像素、设备像素比、PPI、Viewport </a>。</p><h2 id="获取pHYs"><a href="#获取pHYs" class="headerlink" title="获取pHYs"></a>获取pHYs</h2><p>因不是WEB的通用属性，在JS的<code>Img</code>对象中不存在。只能读取图片的二进制提取。</p><p>参考W3C上的<a target="_blank" rel="noopener" href="https://www.w3.org/TR/PNG/">PNG的描述</a>，PNG由<code>头部描述</code> + <code>若干Chunk</code>构成。头部仅包含<code>Width</code>、<code>Height</code>等属性。而我们所需要的分辨率，在某个<code>Chunk</code>中。</p><p><img src="https://edeity.oss-cn-shenzhen.aliyuncs.com/png_data.png" alt="PNG组成"></p><p><small><a target="_blank" rel="noopener" href="https://blog.csdn.net/liuyaqi1993/article/details/77531328">图片来源</a></small></p><p>通过观（yi）察（yin），发现某个Chunk的名称为<code>pHYs</code>（Physical pixel dimensions：物理像素密度）。死马当活马医，假设就是他了。</p><ul><li>首先，扒开他的外衣（读取二进制数据<code>ArrayBuffer</code>）。</li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 假设通过&lt;Input&gt;获取了file</span></span><br><span class="line"><span class="keyword">let</span> file = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;input[type=file]&#x27;</span>).files[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">let</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">reader.onload = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> arrayBuffer = e.target.result;</span><br><span class="line">&#125;</span><br><span class="line">reader.readAsArrayBuffer(fiel);</span><br></pre></td></tr></table></figure><ul><li>而后做一下热身运动（参（chao）考（xi）解析<code>ArrayBuffer</code>的方法）。</li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 通过offset读取buffer数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readUint</span>(<span class="params">buff,p</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (buff[p]*(<span class="number">256</span>*<span class="number">256</span>*<span class="number">256</span>)) + ((buff[p+<span class="number">1</span>]&lt;&lt;<span class="number">16</span>) </span><br><span class="line">            | (buff[p+<span class="number">2</span>]&lt;&lt; <span class="number">8</span>) | buff[p+<span class="number">3</span>]);  </span><br><span class="line">&#125;</span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">readASCII</span>(<span class="params">buff,p,l</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">let</span> s = <span class="string">&quot;&quot;</span>;  </span><br><span class="line">     <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;l; i++) &#123; </span><br><span class="line">         s += <span class="built_in">String</span>.fromCharCode(buff[p+i]);</span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="keyword">return</span> s;    </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><ul><li>最后，在<code>ArrayBuffer</code>身上摸来摸去，手法如下：<ul><li><code>ArrayBuffer</code>是数据原始二进制缓冲区，可通过<code>new Int8Array(buffer.slice(4))</code>切割。<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/TypedArray">TypeArray</a>是处理二进制的数据结构。</li><li>PNG的每个Chunk，开始的数据会声明<code>长度</code>和<code>名称</code>。通过<code>长度</code>，可推断下一个Chunk的位置，类同索引。</li><li>图片结束时，会有<code>IEND</code>标志，假若出现了<code>IEND</code>也没有发现<code>pHYs</code>属性，证明此PNG图片无<code>pHYs</code>属性。</li></ul></li></ul><p>完整代码如下：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_pHYs</span>(<span class="params">buffer</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> isFind = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">let</span> pHYs = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(!isFind) &#123;</span><br><span class="line">        <span class="keyword">let</span> len  = readUint(data, offset);  offset += <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">let</span> type = readASCII(data, offset, <span class="number">4</span>);  offset += <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span>(type ===<span class="string">&quot;pHYs&quot;</span>) &#123;</span><br><span class="line">            pHYs = [readUint(data, offset), readUnit(data, offset + <span class="number">4</span>), data[offset + <span class="number">8</span>]];</span><br><span class="line">            isFind = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(type === <span class="string">&quot;IEND&quot;</span> || <span class="built_in">Number</span>.isNaN(len)) &#123;</span><br><span class="line">            pHYs = <span class="number">-1</span>;</span><br><span class="line">            isFind = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            offset += len + <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pHYs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行，得到结果：</p><p><img src="https://edeity.oss-cn-shenzhen.aliyuncs.com/png_dpi.png" alt="pHYs"></p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul><li><p><code>pHYs</code>包含水平像素点，垂直像素点，以及单位标记位；当单位标记位为1时，代表单位<strong>像素/米</strong>，当为0时，则代表未知单位。<small>iconfont的png图标，当标记位为0时，单位是<strong>像素/英尺</strong>；</small></p></li><li><p><a target="_blank" rel="noopener" href="https://github.com/Alexander-Pop/UPNG.js/blob/master/UPNG.js">UPNG</a>类库提供了解析PNG更多属性的方法。上文解析Chunk方法出自此处。</p></li><li><p>关于PNG的更详细信息科参考：<a target="_blank" rel="noopener" href="http://www.alloyteam.com/2017/03/the-story-of-png-get-images-and-pixel-content/">png的故事：获取图片信息和像素内容</a></p></li><li><p>题外话：Emoji字体（<code>utf8mb4</code>），参考<a target="_blank" rel="noopener" href="http://cenalulu.github.io/linux/character-encoding/">十分钟搞清字符集和字符编码</a>。</p></li></ul></div></div></div><div class="more section"><div class="pre"><a class="article-link" href="/bye_2018_and_hi_2019.html"><i class="iconfont icon-right"></i> <span>2018年的日子</span></a></div><div class="next"><a class="article-link" href="/learn_workbox.html">Workbox3初探：让离线缓存变得简单 <i class="iconfont icon-right"></i></a></div></div></main></body><footer class="section fullscreen"><div class="footer-desc">Edeity © 2015-2019 · powered by hexo</div></footer><script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script><script src="/public/js/init.js"></script></html>