<!doctype html><html lang="zh-CN" class="night"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=4,user-scalable=0" name="viewport"><title>Edeity&#39;s Blog</title><meta name="description" content="Try to be a qualified programmer"><meta property="og:type" content="website"><meta property="og:description" content="Try to be a qualified programmer"><meta property="og:title" content="Edeity&#39;s Blog"><meta property="og:site_name" content="Edeity&#39;s Blog"><meta property="og:url" content="https://blog.edeity.me"><meta property="og:image" content="https://edeity.oss-cn-shenzhen.aliyuncs.com/public/edeity_o.png"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="mainfest" href="/mainfest.json"><link rel="stylesheet" href="/public/css/common.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_707055_4b9og9sc5lx.css"><script>document.addEventListener("DOMContentLoaded",(function(){let e=-1!==window.location.search.indexOf("theme=night")||"night"===window.localStorage.getItem("edeity-theme_theme"),t=-1!==window.location.search.indexOf("theme=light")||"light"===window.localStorage.getItem("edeity-theme_theme"),o=(new Date).getHours();o=22;var n=document.querySelector("html");(e?n.classList.add("night"):t?n.classList.remove("night"):n.classList.add("night"),null!==document.querySelector("ol.toc"))&&(document.querySelector("#nav-bar").style.cssText="display: block")}))</script><meta name="generator" content="Hexo 5.2.0"></head><body><div class="loading"></div><div id="switch" data-switch="{&#34;toc&#34;:true,&#34;use_pwa&#34;:false}"></div><header class="fullscreen"><div class="toolbar"><i class="iconfont icon-menu"></i></div><h1><a href="/">Edeity&#39;s Blog</a></h1><div class="head-link"><a class="btn waves" href="/"><span><i class="iconfont icon-home">Home </i></span></a><a class="btn waves" href="/about/index.html"><span><i class="iconfont icon-me">About </i></span></a><a class="btn waves" target="_blank" rel="noopener" href="https://github.com/edeity"><span><i class="iconfont icon-github">Github</i></span></a></div></header><div class="some-link"><a class="btn" id="light-or-not"><i class="iconfont icon-light"></i> </a><a style="display:none" class="btn" id="up-to-top"><i class="iconfont icon-up"></i></a></div><div id="nav-bar" style="display:none"><div class="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E6%AC%A1%E6%80%A7%E6%8F%90%E4%BA%A4"><span class="toc-number">1.</span> <span class="toc-text">一次性提交</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%94%81"><span class="toc-number">2.</span> <span class="toc-text">内存锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E6%88%B3"><span class="toc-number">3.</span> <span class="toc-text">时间戳</span></a></li></ol></div></div><main id="content-main" class="section"><div class="list-item"><h1 class="post-title"><a id="产品回顾：单据，及数据一致性" class="article-link" href="">产品回顾：单据，及数据一致性</a></h1><div class="post-meta"><time class="meta published">Sep 3, 2017</time></div><div class="article"><div class="post-excerpt markdown-body"><blockquote><p>单据，各行各业用来记录在经济业务过程或结果的一种凭证</p></blockquote><p>NC的单据，在展示方式通常包含<strong>列表态</strong>和<strong>卡片态</strong></p><p>基于列表态和卡片态可以衍生多个数据副本</p><p>数据的表现形式一般为：<strong>表头</strong>，<strong>表体</strong>，<strong>表尾</strong>；一般地，表头记录通用数据，表体记录差异数据，表尾记录操作动作等相关信息等；</p><p>不考虑业务逻辑，则可简单认为，单据就是对一个业务流中涉及的多个数据库表的<strong>增删改查的一种组织形式</strong>；</p><img class="gif" width="686" height="348" data-src="https://edeity.oss-cn-shenzhen.aliyuncs.com/2017/bcs.gif"><div class="img-desc">单据：调整凭证制单</div>在上图基本单据的实现过程中，遇到了两点挑战：<ol><li>前端，列表态，卡片态表头表体以及衍生多个数据副本之间的数据转换</li><li>前端展示与后台数据的一致性</li></ol><p>在此仅记录在保证一致性的一些实用技巧（前端角度，后台同学勿取笑）</p><h2 id="一次性提交"><a href="#一次性提交" class="headerlink" title="一次性提交"></a>一次性提交</h2><p>要点有二：</p><ol><li><p>只提交发生改变的数据：减轻网络层及服务端压力，基本技巧，略过；</p></li><li><p>一次性提交</p><p>原考虑不周，表头和表体是分开提交的；然而表头表体保存时，既有基本属性校验，也有业务逻辑计算，后台时有抛错，导致表头保存成功后表体不成功（表体是在表头保存成功后回调保存）；假若一次提交，则能利用数据库，进行<strong>事务级的回滚</strong>。</p><p>另一点，就是初步定需求时，表头表体仅以表头主键关联，后续在执行规则（某种业务逻辑）时，才发现需根据单据所有表体计算合并范围（保存到表头），假如分开提交，则需在表体成功后进行回写操作，这种影响<strong>数据流单向流动</strong>的操作，一般是不鼓励的。一次性提交能降低某些隐性需求浮现时对代码层的影响。</p><p>当然，若能屏蔽数据库的表，在前台仅以统一数据结构出现，能大大减低数据流操作以及前后台刷新同步的复杂程度。不幸的是kero.js对数组和对象的MVVM支持仍停留在石器时代，只好作罢；</p></li></ol><h2 id="内存锁"><a href="#内存锁" class="headerlink" title="内存锁"></a>内存锁</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BDPKLockUtil.lockString(pk_vouchhead); <span class="comment">// pk_vouchhead，唯一标识</span></span><br></pre></td></tr></table></figure><p>基本原理就是每一单据生成一个唯一标示，并索引是否已存在，若存在，则抛错，否则，锁定至事务执行完毕；个人觉得还是一种比较简单优雅的实现。</p><h2 id="时间戳"><a href="#时间戳" class="headerlink" title="时间戳"></a>时间戳</h2><p>时间戳则是用来保证业务员总应在最新的数据上进行操作。基本原理就是在表内添加<code>TS</code>列，记录每次操作的时间。假如提交的数据中，最后修改的时间和当前数据库存储的时间不一致，则可认为版本过旧或版本错误；也能从侧面防止假数据的录入。</p></div></div></div><div class="more section"><div class="pre"><a class="article-link" href="/fe_app_with_mac.html"><i class="iconfont icon-right"></i> <span>MAC之前端常用APP 和 技巧</span></a></div><div class="next"><a class="article-link" href="/byd_2016_and_hi_2017.html">Bye 2016, Hi 2017 <i class="iconfont icon-right"></i></a></div></div></main></body><footer class="section fullscreen"><div class="footer-desc">Edeity © 2015-2019 · powered by hexo</div></footer><script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script><script src="/public/js/init.js"></script></html>